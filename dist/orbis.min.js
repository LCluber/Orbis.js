/** MIT License
* 
* Copyright (c) 2011 Ludovic CLUBER 
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* http://orbisjs.lcluber.com
*/

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("../../bower_components/Weejs/dist/wee.js"),require("../../bower_components/Mouettejs/dist/mouette.js"),require("../../bower_components/Taipanjs/dist/taipan.js")):"function"==typeof define&&define.amd?define(["exports","../../bower_components/Weejs/dist/wee.js","../../bower_components/Mouettejs/dist/mouette.js","../../bower_components/Taipanjs/dist/taipan.js"],t):t(e.ORBIS={},e.WEE,e.MOUETTE,e.TAIPAN)}(this,function(e,t,s,n){"use strict";var i=function(){function e(){this.fsm=new n.FSM([{name:"send",from:"idle",to:"pending"},{name:"success",from:"pending",to:"success"},{name:"error",from:"pending",to:"error"}])}return e.prototype.send=function(e,n){var i=this;if(this.fsm.send())return t[t.String.ucfirst(n)].load(e).then(function(e){return i.fsm.success(),e}).catch(function(e){return s.Logger.error(e.message),i.fsm.error(),!1})},e}(),r=function(){function e(e,t,s,n){this.path=e,this.file=t,this.extension=s,this.type=n,this.request=new i}return e.prototype.sendRequest=function(){var e=this;return this.request.send(this.path+this.file,this.type).then(function(s){if(s&&(e.response=s,"file"===e.type)){var n=t.Check.isJSON(s);n&&(e.response=n)}return e.file})},e.prototype.getRequestStatus=function(){return this.request.fsm.state},e.prototype.isRequestSent=function(){return"idle"!=this.getRequestStatus()},e}(),o=function(){function e(e,s,n){if(this.rate=0,this.total=0,this.percentage=0,this.target=0,this.speed=40,this.nbAssets=n,e&&(i=t.Dom.findById(e))&&(this.bar=new t.Bind(i,"0")),s){var i=t.Dom.findById(s);i&&(this.text=new t.Bind(i,"Loading started"))}}return e.prototype.update=function(e){this.total++,this.rate=this.total/this.nbAssets,this.target=Math.round(100*this.rate),this.text.change(e)},e.prototype.updateBar=function(e){return e*=.001,this.percentage+=this.speed*e,this.percentage>=this.target&&(this.percentage=this.target),this.bar.change(this.percentage),100===this.percentage&&this.text.change("Loading complete"),this.percentage},e}(),a=function(){function e(){this.default={maxPending:6,tick:100},this.validExtensions={file:["txt","text","json","glsl","babylon"],img:["png","jpg","jpeg","gif"],sound:["mp3","ogg","wav"]},this.pendingRequests=0,this.tick=this.default.tick,this.maxPendingRequests=this.default.maxPending}return e.prototype.getAsset=function(e){for(var t in this.assets)if(this.assets.hasOwnProperty(t))for(var s=0,n=this.assets[t].files;s<n.length;s++){var i=n[s];if(i.name==e)return i}return!1},e.prototype.getList=function(e){return!!this.assets.hasOwnProperty(e)&&this.assets[e].files},e.prototype.launch=function(e,n,r,a){var u=this;return new Promise(function(h,f){var p=new i,c=t.File.getExtension(e),d=u.getAssetType(c);if("file"===d)return p.send(e,d).then(function(e){if(e){var s=t.Check.isJSON(e);if(s){u.assets=s;var i=u.createAssets(t.File.removeTrailingSlash(n));if(i){u.progress=new o(r,a,i);var p=setInterval(function(){u.sendRequest(),100===u.progress.updateBar(u.tick)&&(clearInterval(p),h())},u.tick)}else f("!! nothing to load here")}}}).catch(function(t){s.Logger.error(e+" : "+t.message),console.log("error",t.message)});f('!! the config file must be of type "file"')})},e.prototype.getAssetType=function(e){for(var s in this.validExtensions)if(this.validExtensions.hasOwnProperty(s)&&t.File.checkExtension(e,this.validExtensions[s]))return s;return!1},e.prototype.createAssets=function(e){var s=0;for(var n in this.assets)if(this.assets.hasOwnProperty(n))for(var i=this.assets[n],o=i.folder?i.folder+"/":"",a=0,u=i.files;a<u.length;a++){var h=u[a];if(h.hasOwnProperty("name")){var f=t.File.getExtension(h.name),p=this.getAssetType(f);p&&(h.asset=new r(e+"/"+o,h.name,f,p),s++)}}return s},e.prototype.sendRequest=function(){var e=this;if(this.pendingRequests<this.maxPendingRequests){var t=this.getNextAssetToLoad();return!!t&&(t.sendRequest().then(function(t){e.pendingRequests--,e.progress.update(t)}),!0)}},e.prototype.getNextAssetToLoad=function(){for(var e in this.assets)if(this.assets.hasOwnProperty(e))for(var t=0,s=this.assets[e].files;t<s.length;t++){var n=s[t];if(n.hasOwnProperty("asset")&&!n.asset.isRequestSent())return n.asset}return!1},e}();e.Loader=a,Object.defineProperty(e,"__esModule",{value:!0})});