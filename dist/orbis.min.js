/** MIT License
* 
* Copyright (c) 2011 Ludovic CLUBER 
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* http://orbisjs.lcluber.com
*/

var ORBIS={revision:"0.4.10",assets:{},assetsPath:"",requests:{},requestsLength:0,sentRequests:0,onProgress:function(){},onComplete:function(){},progress:{},pending:0,tick:0,maxPending:0,defaultMaxPending:6,defaultTick:100,logs:{},create:function(t,e,s,n,i){var r=Object.create(this);return r.logs=ORBIS.Logger.create(),r.logs.init(),ORBIS.Utils.isFunction(t)?r.onProgress=t:r.logs.add("onProgress parameter is not a function"),ORBIS.Utils.isFunction(s)?r.onComplete=s:r.logs.add("onComplete parameter is not a function"),r.progress=ORBIS.Progress.create(e),r.setTick(n),r.setMaxPending(i),r},launch:function(t,e){this.progress.init(),this.assetsPath=ORBIS.Utils.removeTrailingSlash(e),this.assets.fsm&&"success"===this.assets.fsm.getStatus()?(this.logs.add(t+" already loaded."),this.onAssetsFileLoaded("success",this.assets.response,this)):(this.logs.add("create request for "+t),this.assets=ORBIS.Request.create(t,"file","",this.onAssetsFileLoaded,this),this.assets?this.assets.send():this.logs.add('!! the config file must be of type "file"'))},onAssetsFileLoaded:function(t,e,s){if("success"==t){s.logs.add("parsing asset file"),s.requestsLength=0,s.sentRequests=0;for(var n in e.json)if(e.json.hasOwnProperty(n))for(var i=e.json[n],r=i.files,o=i.folder?i.folder+"/":"",a=0;a<r.length;a++){var c=r[a],h=c.hasOwnProperty("file")?c.file:c,u=s.assetsPath+"/"+o+h;if(s.getAsset(h))s.logs.add(u+" already loaded.");else{var l=ORBIS.Request.create(u,"",c,s.onFileLoaded,s);"string"!=typeof l.file?(s.logs.add("create request for "+u),s.requests[h]=l,s.requestsLength++):s.logs.add(l.file)}}s.logs.add(s.requestsLength+" requests to perform"),s.sendRequest()}else s.logs.add("!! error during config file AJAX request")},sendRequest:function(){if(this.pending<this.maxPending){var t=Object.keys(this.requests)[this.sentRequests];(this.getAsset(t)||"error"==this.requests[t].send())&&this.updateProgress(0,this.getAsset(t).response),this.pending++,this.sentRequests++}this.sentRequests<this.requestsLength&&setTimeout(this.loadAnotherFile.bind(this),this.tick)},loadAnotherFile:function(){this.sendRequest()},onFileLoaded:function(t,e,s){s.updateProgress(t,e)},updateProgress:function(t,e){var s=this.progress.update(t,this.requestsLength);this.pending>0&&this.pending--,this.logs.add("progress "+this.progress.target+"%"),this.onProgress(this.progress.target,e),s||(this.logs.add("loading complete"),this.onComplete(this.getLogs()))},getList:function(t){if(this.assets.response.json.hasOwnProperty(t)){for(var e=[],s=this.assets.response.json[t].files,n=0;n<s.length;n++){var i=this.getAsset(s[n]);i&&e.push(i)}return e}return!1},getAsset:function(t){return!(!this.requests[t]||"success"!==this.requests[t].fsm.getStatus())&&this.requests[t]},setScope:function(t){if(!ORBIS.Utils.isObject(t))return!1;this.onProgress=this.onProgress.bind(t),this.progress.onAnimate=this.progress.onAnimate.bind(t),this.onComplete=this.onComplete.bind(t)},getTick:function(){return this.tick},setTick:function(t){this.tick=ORBIS.Utils.valueValidation(t)?ORBIS.Utils.valueValidation(t):this.defaultTick},getMaxPending:function(){return this.maxPending},setMaxPending:function(t){this.maxPending=ORBIS.Utils.valueValidation(t)?ORBIS.Utils.valueValidation(t):this.defaultMaxPending},getLogs:function(){return this.logs.get()},setProgressSpeed:function(t){return this.progress.speed=TYPE6.MathUtils.clamp(ORBIS.Utils.valueValidation(t),10,100),this.progress.speed}};ORBIS.Logger={logs:"",create:function(){return Object.create(this)},init:function(){this.logs=""},get:function(){return this.logs},add:function(t){this.logs+=t+"\n"}},ORBIS.File={path:"",directory:"",name:"",extension:"",type:"",extensions:{file:["txt","text","json","glsl","babylon"],image:["png","jpg","jpeg","gif"],sound:["mp3","ogg","wav"]},create:function(t,e){var s=Object.create(this);s.path=t,s.extractExtension();var n=s.checkExtension(e);return!0===n?(s.extractDirectory(),s.extractName(),s):n},getPath:function(){return this.path},getName:function(){return this.name},getExtension:function(){return this.extension},getType:function(){return this.type},extractName:function(){this.name=!!this.path&&this.path.replace(/^.*[\\\/]/,"")},extractDirectory:function(){this.directory=!!this.path&&this.path.replace(/[^\\\/]*$/,"")},extractExtension:function(){this.extension=!!this.path&&this.path.split(".").pop()},checkExtension:function(t){for(var e in this.extensions)if(this.extensions.hasOwnProperty(e)&&(!t||t==e))for(var s=0;s<this.extensions[e].length;s++)if(this.extensions[e][s]==this.extension)return this.type=e,!0;return'Invalid file extension for "'+this.path+'"'}},ORBIS.AjaxRequest=function(t,e,s,n){var i=new XMLHttpRequest;s&&(t+="?cache="+(new Date).getTime()),i.open("GET",t,e),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){4==this.readyState&&200==this.status&&n(this.responseText)},i.send()},ORBIS.Utils={getFileName:function(t){return!!t&&t.replace(/^.*[\\\/]/,"")},removeTrailingSlash:function(t){return!!t&&t.replace(/\/+$/,"")},valueValidation:function(t){return isNaN(t)?0:Math.abs(Math.round(t))},isJSON:function(t){var e=t.replace(/(\r\n|\n|\r|\t)/gm,"");try{e=JSON.parse(t)}catch(t){return t}return e},isFunction:function(t){var e={};return t&&"[object Function]"===e.toString.call(t)},isObject:function(t){return null!==t&&(this.isFunction(t)||"object"==typeof t)}},ORBIS.LoadImage=function(t,e,s){var n=new Image;return n.src=t,n.name=ORBIS.Utils.getFileName(t),n.addEventListener("load",function(){e(1,s)},!1),n.addEventListener("error",function(){e(0,s)},!1),n},ORBIS.LoadSound=function(t,e,s){var n=new Audio;return n.src=t,n.name=ORBIS.Utils.getFileName(t),n.addEventListener("canplaythrough",function(){e(1,s)},!1),n.addEventListener("canplay",function(){e(1,s)},!1),n.addEventListener("error",function(){e(0,s)},!1),n},ORBIS.LoadFile=function(t,e,s){var n={};return n.src=t,n.name=ORBIS.Utils.getFileName(t),n.data="",n.json="",ORBIS.AjaxRequest(t,!0,1,function(t){t&&(n.data=t,n.json=ORBIS.Utils.isJSON(t)),e(t?1:0,s)}),n},ORBIS.Progress={rate:0,percentage:0,target:0,speed:40,success:0,error:0,total:0,animation:{},onAnimate:function(){},create:function(t){var e=Object.create(this);return e.animation=FRAMERAT.create(e.animate,e),ORBIS.Utils.isFunction(t)&&(e.onAnimate=t),e},init:function(){this.rate=0,this.percentage=0,this.target=0,this.success=0,this.error=0,this.total=0},update:function(t,e){return t?this.onSuccess():this.onError(),this.total++,this.rate=e?this.total/e:1,this.target=Math.round(100*this.rate),this.animation.play(),this.checkComplete()},animate:function(){this.percentage+=this.speed*this.animation.getDelta().getSecond(),this.percentage>=this.target?(this.percentage=this.target,this.animation.stop()):this.animation.newFrame(),this.onAnimate(this.percentage)},onSuccess:function(){this.success++},onError:function(){this.error++},checkComplete:function(){return!(this.rate>=1)}},ORBIS.Request={file:{},response:{},fsm:{},callback:{method:function(){},scope:{}},json:{},loaders:{file:"LoadFile",image:"LoadImage",sound:"LoadSound"},logs:{},create:function(t,e,s,n,i){var r=Object.create(this);return r.logs=i.logs,r.createFile(t,e),"string"==typeof this.file?this.file:(r.createCallback(n,i),r.createFSM(),r.addInfo(s),r)},createFile:function(t,e){this.file=ORBIS.File.create(t,e)},createCallback:function(t,e){this.callback={},this.callback.method=t,this.callback.scope=e},createFSM:function(){this.fsm=TAIPAN.create([{name:"send",from:"idle",to:"pending"},{name:"success",from:"pending",to:"success"},{name:"error",from:"pending",to:"error"}])},addInfo:function(t){if(t.hasOwnProperty("file")){this.json={};for(var e in t)t.hasOwnProperty(e)&&"file"!==e&&(this.json[e]=t[e])}},send:function(){return this.logs.add("send "+this.file.getName()+", Status "+this.fsm.getStatus()),this.fsm.send(),this.file.getType()?this.response=ORBIS[this.loaders[this.file.getType()]](this.file.path,this.onComplete,this):(this.fsm.error(),this.logs.add("!! invalid file type. Cannot load "+this.file.path+". Status "+this.fsm.getStatus())),this.fsm.getStatus()},onComplete:function(t,e){var s=!1;t?s=e.fsm.success():(s=e.fsm.error(),e.logs.add("!! error during AJAX request for : "+e.file.path+".")),s&&(e.logs.add("complete "+e.file.getName()+". Status "+e.fsm.getStatus()),e.callback.method(e.fsm.getStatus(),e.response,e.callback.scope))}};