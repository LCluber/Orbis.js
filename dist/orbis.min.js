/** MIT License
* 
* Copyright (c) 2011 Ludovic CLUBER 
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* http://orbisjs.lcluber.com
*/
var ORBIS={revision:"0.4.3",assets:{},assetsPath:"",requests:{},requestsLength:0,sentRequests:0,onProgress:function(){},onComplete:function(){},progress:{},pending:0,tick:0,maxPending:0,defaultMaxPending:6,defaultTick:100,logs:{},create:function(a,b,c,d,e){var f=Object.create(this);return f.logs=ORBIS.Logger.create(),f.logs.init(),ORBIS.Utils.isFunction(a)?f.onProgress=a:f.logs.add("onProgress Parameter is not a function"),ORBIS.Utils.isFunction(c)?f.onComplete=c:f.logs.add("onComplete Parameter is not a function"),f.progress=ORBIS.Progress.create(b),f.setTick(d),f.setMaxPending(e),f},launch:function(a,b){this.progress.init(),this.assetsPath=ORBIS.Utils.removeTrailingSlash(b),this.assets.fsm&&"success"===this.assets.fsm.getStatus()?(this.logs.add(a+" already loaded."),this.onAssetsFileLoaded("success",this.assets.response,this)):(this.logs.add("create request for "+a),this.assets=ORBIS.Request.create(a,"file","",this.onAssetsFileLoaded,this),this.assets?this.assets.send():this.logs.add('!! the config file must be of type "file"'))},onAssetsFileLoaded:function(a,b,c){if("success"==a){c.logs.add("parsing asset file"),c.requestsLength=0,c.sentRequests=0;for(var d in b.json)if(b.json.hasOwnProperty(d))for(var e=b.json[d],f=e.files,g=e.folder?e.folder+"/":"",h=0;h<f.length;h++){var i=f[h],j=i.hasOwnProperty("file")?i.file:i,k=c.assetsPath+"/"+g+j;if(c.getAsset(j))c.logs.add(k+" already loaded.");else{var l=ORBIS.Request.create(k,"",i,c.onFileLoaded,c);"string"!=typeof l.file?(c.logs.add("create request for "+k),c.requests[j]=l,c.requestsLength++):c.logs.add(l.file)}}c.logs.add(c.requestsLength+" requests to perform"),c.sendRequest()}else c.logs.add("!! error during config file AJAX request")},sendRequest:function(){if(this.pending<this.maxPending){var a=Object.keys(this.requests)[this.sentRequests];(this.getAsset(a)||"error"==this.requests[a].send())&&this.updateProgress(0,this.getAsset(a).response),this.pending++,this.sentRequests++}this.sentRequests<this.requestsLength&&setTimeout(this.loadAnotherFile.bind(this),this.tick)},loadAnotherFile:function(){this.sendRequest()},onFileLoaded:function(a,b,c){c.updateProgress(a,b)},updateProgress:function(a,b){var c=this.progress.update(a,this.requestsLength);this.pending>0&&this.pending--,this.logs.add("progress "+this.progress.target+"%"),this.onProgress(this.progress.target,b),c||(this.logs.add("loading complete"),this.onComplete(this.getLogs()))},getList:function(a){if(this.assets.response.json.hasOwnProperty(a)){for(var b=[],c=this.assets.response.json[a].files,d=0;d<c.length;d++){var e=this.getAsset(c[d]);e&&b.push(e)}return b}return!1},getAsset:function(a){return!(!this.requests[a]||"success"!==this.requests[a].fsm.getStatus())&&this.requests[a]},setScope:function(a){return!!ORBIS.Utils.isObject(a)&&(this.onProgress=this.onProgress.bind(a),this.progress.onAnimate=this.progress.onAnimate.bind(a),this.onComplete=this.onComplete.bind(a),void 0)},getTick:function(){return this.tick},setTick:function(a){this.tick=ORBIS.Utils.valueValidation(a)?ORBIS.Utils.valueValidation(a):this.defaultTick},getMaxPending:function(){return this.maxPending},setMaxPending:function(a){this.maxPending=ORBIS.Utils.valueValidation(a)?ORBIS.Utils.valueValidation(a):this.defaultMaxPending},getLogs:function(){return this.logs.get()}};ORBIS.Logger={logs:"",create:function(){var a=Object.create(this);return a},init:function(){this.logs=""},get:function(){return this.logs},add:function(a){this.logs+=a+"\n"}},ORBIS.File={path:"",directory:"",name:"",extension:"",type:"",extensions:{file:["txt","text","json","babylon"],image:["png","jpg","jpeg","gif"],sound:["mp3","ogg","wav"]},create:function(a,b){var c=Object.create(this);c.path=a,c.extractExtension();var d=c.checkExtension(b);return d===!0?(c.extractDirectory(),c.extractName(),c):d},getPath:function(){return this.path},getName:function(){return this.name},getExtension:function(){return this.extension},getType:function(){return this.type},extractName:function(){this.name=!!this.path&&this.path.replace(/^.*[\\\/]/,"")},extractDirectory:function(){this.directory=!!this.path&&this.path.replace(/[^\\\/]*$/,"")},extractExtension:function(){this.extension=!!this.path&&this.path.split(".").pop()},checkExtension:function(a){for(var b in this.extensions)if(this.extensions.hasOwnProperty(b)&&(!a||a==b))for(var c=0;c<this.extensions[b].length;c++)if(this.extensions[b][c]==this.extension)return this.type=b,!0;return'Invalid file extension for "'+this.path+'"'}},ORBIS.AjaxRequest=function(a,b,c,d){var e=new XMLHttpRequest;c&&(a+="?cache="+(new Date).getTime()),e.open("GET",a,b),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){4==this.readyState&&200==this.status&&d(this.responseText)},e.send()},ORBIS.Utils={getFileName:function(a){return!!a&&a.replace(/^.*[\\\/]/,"")},removeTrailingSlash:function(a){return!!a&&a.replace(/\/+$/,"")},valueValidation:function(a){return isNaN(a)?0:Math.abs(Math.round(a))},isJSON:function(a){var b=a.replace(/(\r\n|\n|\r|\t)/gm,"");try{b=JSON.parse(a)}catch(c){return!1}return b},isFunction:function(a){var b={};return a&&"[object Function]"===b.toString.call(a)},isObject:function(a){return null!==a&&(this.isFunction(a)||"object"==typeof a)}},ORBIS.LoadImage=function(a,b,c){var d=new Image;return d.src=a,d.name=ORBIS.Utils.getFileName(a),d.addEventListener("load",function(){b(1,c)},!1),d.addEventListener("error",function(){b(0,c)},!1),d},ORBIS.LoadSound=function(a,b,c){var d=new Audio;return d.src=a,d.name=ORBIS.Utils.getFileName(a),d.addEventListener("canplaythrough",function(){b(1,c)},!1),d.addEventListener("canplay",function(){b(1,c)},!1),d.addEventListener("error",function(){b(0,c)},!1),d},ORBIS.LoadFile=function(a,b,c){var d={};return d.src=a,d.name=ORBIS.Utils.getFileName(a),d.data="",d.json="",ORBIS.AjaxRequest(a,!0,1,function(a){a&&(d.data=a,d.json=ORBIS.Utils.isJSON(a)),b(a?1:0,c)}),d},ORBIS.Progress={rate:0,percentage:0,target:0,speed:40,success:0,error:0,total:0,animation:{},onAnimate:function(){},create:function(a){var b=Object.create(this);return b.animation=FRAMERAT.create(b.animate),ORBIS.Utils.isFunction(a)&&(b.onAnimate=a),b},init:function(){this.rate=0,this.percentage=0,this.target=0,this.success=0,this.error=0,this.total=0},update:function(a,b){return a?this.onSuccess():this.onError(),this.total++,this.rate=b?this.total/b:1,this.target=Math.round(100*this.rate),this.animation.play(this),this.checkComplete()},animate:function(){this.percentage+=this.speed*this.animation.getDelta().getSecond(),this.percentage>=this.target?(this.percentage=this.target,this.animation.stop()):this.animation.newFrame(this),this.onAnimate(this.percentage)},onSuccess:function(){this.success++},onError:function(){this.error++},checkComplete:function(){return!(this.rate>=1)}},ORBIS.Request={file:{},response:{},fsm:{},callback:{method:function(){},scope:{}},json:{},loaders:{file:"LoadFile",image:"LoadImage",sound:"LoadSound"},logs:{},create:function(a,b,c,d,e){var f=Object.create(this);return f.logs=e.logs,f.createFile(a,b),"string"==typeof this.file?this.file:(f.createCallback(d,e),f.createFSM(),f.addInfo(c),f)},createFile:function(a,b){this.file=ORBIS.File.create(a,b)},createCallback:function(a,b){this.callback={},this.callback.method=a,this.callback.scope=b},createFSM:function(){this.fsm=TAIPAN.create([{name:"send",from:"idle",to:"pending"},{name:"success",from:"pending",to:"success"},{name:"error",from:"pending",to:"error"}])},addInfo:function(a){if(a.hasOwnProperty("file")){this.json={};for(var b in a)a.hasOwnProperty(b)&&"file"!==b&&(this.json[b]=a[b])}},send:function(){return this.logs.add("send "+this.file.getName()+", Status "+this.fsm.getStatus()),this.fsm.send(),this.file.getType()?this.response=ORBIS[this.loaders[this.file.getType()]](this.file.path,this.onComplete,this):(this.fsm.error(),this.logs.add("!! invalid file type. Cannot load "+this.file.path+". Status "+this.fsm.getStatus())),this.fsm.getStatus()},onComplete:function(a,b){var c=!1;a?c=b.fsm.success():(c=b.fsm.error(),b.logs.add("!! error during AJAX request for : "+b.file.path+".")),c&&(b.logs.add("complete "+b.file.getName()+". Status "+b.fsm.getStatus()),b.callback.method(b.fsm.getStatus(),b.response,b.callback.scope))}};
var FRAMERAT={revision:"0.2.1",id:null,onAnimate:function(){},frameNumber:0,fsm:{},clock:{},frameId:0,create:function(a){var b=Object.create(this);return b.onAnimate=a,b.createFSM(),b.clock=FRAMERAT.Clock.create(),b},createFSM:function(){this.fsm=TAIPAN.create([{name:"play",from:"paused",to:"running"},{name:"pause",from:"running",to:"paused"}])},play:function(a){return this.fsm.play()&&(this.clock.start(),this.requestNewFrame(a)),this.fsm.getStatus()},pause:function(){return this.fsm.pause()&&this.cancelAnimation(),this.fsm.getStatus()},stop:function(){this.pause(),this.clock.init(),this.frameNumber=0},getTotalTime:function(a){return this.clock.getTotal(a)},getFrameNumber:function(){return this.frameNumber},getRoundedDelta:function(a,b){return this.computeRoundedDelta(a,b),this.clock.getRoundedDelta()},computeRoundedDelta:function(a,b){this.frameNumber%a===0&&this.clock.computeRoundedDelta(b)},getDelta:function(){return this.clock.getDelta()},getFramePerSecond:function(a,b){return this.frameNumber%a===0&&this.clock.computeFramePerSecond(b),this.clock.getFramePerSecond()},newFrame:function(a){this.requestNewFrame(a),this.clock.tick()},requestNewFrame:function(a){a?this.frameId=window.requestAnimationFrame(this.onAnimate.bind(a)):this.frameId=window.requestAnimationFrame(this.onAnimate),this.frameNumber++},cancelAnimation:function(){window.cancelAnimationFrame(this.frameId)}};FRAMERAT.Time={millisecond:0,second:0,create:function(a){var b=Object.create(this);return b.set(a,0),b},set:function(a,b){this.millisecond=Math.max(a,b),this.second=this.millisecondToSecond(this.millisecond)},getSecond:function(){return this.second},getMillisecond:function(){return this.millisecond},millisecondToSecond:function(a){return.001*a}},FRAMERAT.Clock={revision:"0.1.0",minimumTick:16,old:performance.now(),"new":performance.now(),total:0,fps:0,delta:FRAMERAT.Time.create(0),roundedDelta:FRAMERAT.Time.create(0),create:function(){var a=Object.create(this);return a.init(),a},init:function(){this.total=0,this.fps=0,this.delta.set(0,this.minimumTick)},start:function(){this.old=performance.now()},tick:function(){this["new"]=performance.now(),this.delta.set(this["new"]-this.old,this.minimumTick),this.old=this["new"],this.total+=this.delta.second},getTotal:function(a){return this.round(this.total,a)},computeRoundedDelta:function(a){this.roundedDelta.second=this.delta.second?this.round(this.delta.second,a):0,this.roundedDelta.millisecond=this.delta.millisecond?this.round(this.delta.millisecond,a):0},getRoundedDelta:function(){return this.roundedDelta},getDelta:function(){return this.delta},computeFramePerSecond:function(a){this.fps=this.round(1e3/this.delta.millisecond,a)},getFramePerSecond:function(){return this.fps},round:function(a,b){return b=Math.pow(10,b),Math.round(a*b)/b}},function(){if("performance"in window==!1&&(window.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in window.performance==!1){var a=Date.now();performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-a}}}(),function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();
var TAIPAN={revision:"0.2.0",create:function(a){var b=Object.create(this);return b.config=a,b.status=TAIPAN.States.create(b.config),b.createEvents(),b},createEvents:function(){for(var a=0;a<this.config.length;a++){var b=this.config[a];this.hasOwnProperty(b.name)||(this[b.name]=this.setStatus(b.from,b.to))}},getStatus:function(){for(var a in this.status)if(this.status[a]===!0)return a;return!1},setStatus:function(a,b){return function(){return this.status[a]===!0&&(this.status[a]=!1,this.status[b]=!0,!0)}}};TAIPAN.States={create:function(a){for(var b=Object.create(this),c=0;c<a.length;c++){var d=a[c];this.hasOwnProperty(d.from)||(this[d.from]=!c),this.hasOwnProperty(d.to)||(this[d.to]=!1)}return b}};